const e={CACHE_SIZE:100},t={},n=[];function r(e){return n.find(t=>e.match(t.regex))}function l(){const n=Object.values(t);e.CACHE_SIZE>n.length||n.forEach(e=>{e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(t[e.url].timeout),delete t[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)})}function o(e,n){if(t[e])return t[e];setTimeout(l);const o=r(e);if(!o)throw Error(`No plugin for ${e}`);const a={url:e,plugin:o,value:n,callbacks:{}};return t[e]=a,o.checkInterval&&(a.intervals={},a.minInterval=1/0),void 0!==o.threshold&&(a.last=-1/0),o.getEndpoint&&o.getEndpoint(a),a}function a(e,n,r){const l=t[e];var o;do{o=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(l.callbacks[o]);return l.callbacks[o]=n,l.intervals&&(l.intervals[o]=r=r||l.plugin.checkInterval,l.minInterval=Math.min(l.minInterval,r)),function(e,t){return()=>{e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min(...Object.values(e.intervals))))}}(l,o)}function s(e,t){return e!==t&&(typeof e!=typeof t||(Array.isArray(e)?u(e,t):"object"!=typeof e||function(e,t){if(null===e&&null!==t)return!0;if(null===t)return!0;const n=Object.keys(e);if(u(n,Object.keys(t)))return!0;return n.some(n=>s(e[n],t[n]))}(e,t)))}function u(e,t){return!Array.isArray(t)||(e.length!==t.length||e.some((e,n)=>s(e,t[n])))}function c(e){e.intervals&&(clearTimeout(e.timeout),t[e.url]&&(e.last=Date.now(),e.timeout=setTimeout(()=>{v(e.url)},e.minInterval)))}function i(e,n,r){const l=t[e];if(l)l.clean=void 0,l.intervals&&r&&c(l),s(n,l.value)&&(l.value=n,l.plugin.set&&l.plugin.set(l),Object.values(l.callbacks).forEach(e=>setTimeout(e,0,l.value)));else{const t=o(e,n);t.plugin.set&&(t.value=n,t.plugin.set(t))}}function v(e){const n=t[e];return!!n&&(n.clean=void 0,void 0!==n.plugin.threshold&&Date.now()-n.last<n.plugin.threshold?void 0:(c(n),n.plugin.refresh(n,t=>{i(e,t)}),!0))}function h(e,t,n={}){const{first:r,interval:l}=n,s=o(e,r),u=a(e,t,l);return s.clean=void 0,void 0!==s.value&&t(s.value),Date.now()-s.last>s.plugin.threshold&&v(e),u}function f(e){const n=t[e];if(n)return n.clean=void 0,t[e].value;const l=r(e);return l.get?l.get(e):void 0}const{useState:g,useEffect:d}=require("react");function k(e,t){const[n,r]=g(()=>f(e)||t.first);return d(()=>h(e,r,t),[e]),n}function m(e){n.unshift(e)}var b={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(localStorage[e.key])},getEndpoint(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:e=>localStorage[e.substr(15)],set(e){localStorage[e.key]=e.value}};var p={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(sessionStorage[e.key])},getEndpoint(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:e=>sessionStorage[e.substr(17)],set(e){sessionStorage[e.key]=e.value}};const y=/^(.+?)\.(.*)/;function S(e,t){if(!e)return e;if(void 0!==e[t])return e[t];const n=t.match(y);return n?S(e[n[1]],n[2]):void 0}const E=/^(.+?)\.(.*)/;function j(e,t,n){if(!e)return j({},t,n);if(e[t])return{...e,[t]:n};const r=t.match(E);return r?{...e,[r[1]]:j(e[r[1]],r[2],n)}:{...e,[t]:n}}var I={};function O(e){const n=e.replace(/\.?[^.]*$/,"");if(!n)return;const r=t[n];r&&(r.value=S(I,r.url),Object.values(r.callbacks).forEach(e=>setTimeout(e,0,r.value))),setTimeout(O,0,n)}function w(e){const n=t[e],r=`${e}.`;Object.keys(t).forEach(l=>{if(!l.startsWith(r))return;const o=t[l],a=S(n.value,l.substr(e.length+1));s(a,o.value)&&(o.value=a,Object.values(o.callbacks).forEach(e=>setTimeout(e,0,a)))})}var T={name:"state",regex:/^state:\/\/./,refresh(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint(e){const t=S(I,e.url);if(void 0===t)return I=j(I,e.url,e.value),O(e.url),void w(e.url);e.value=t},get:e=>S(I,e),set(e){I=j(I,e.url,e.value),O(e.url),w(e.url)},clean(e){const n=`${e.url}.`;Object.keys(t).some(e=>e.startsWith(n))||O(e.url)}};m({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:(e,t)=>fetch(e.url).then(e=>{e.json().then(t).catch(()=>{e.text().then(t).catch(t)})}).catch(t)}),m(b),m(p),m(T);export{e as conf,t as endpoints,f as get,h as onGet,n as plugins,v as refresh,m as registerPlugin,i as set,k as useOnGet};
