import e from"isdifferent";import{useState as t,useEffect as n}from"react";import{getValue as r,setValue as l}from"@hacknlove/deepobject";const a={CACHE_SIZE:100},o={},s=[];function i(e){return s.find(t=>e.match(t.regex))}function c(){const e=Object.values(o);a.CACHE_SIZE>e.length||e.forEach(e=>{e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(o[e.url].timeout),delete o[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)})}function u(e,t){if(o[e])return o[e];setTimeout(c);const n=i(e);if(!n)throw Error(`No plugin for ${e}`);const r={url:e,plugin:n,value:t,callbacks:{}};return o[e]=r,n.checkInterval&&(r.intervals={},r.minInterval=1/0),void 0!==n.threshold&&(r.last=-1/0),n.getEndpoint&&n.getEndpoint(r),r}function v(e,t,n){const r=o[e];var l;do{l=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(r.callbacks[l]);return r.callbacks[l]=t,r.intervals&&(r.intervals[l]=n=n||r.plugin.checkInterval,r.minInterval=Math.min(r.minInterval,n)),function(e,t){return()=>{e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min(...Object.values(e.intervals))))}}(r,l)}function h(e){e.intervals&&(clearTimeout(e.timeout),o[e.url]&&(e.last=Date.now(),e.timeout=setTimeout(()=>{f(e.url)},e.minInterval)))}function g(t,n,r){const l=o[t];if(l)l.clean=void 0,l.intervals&&r&&h(l),e(n,l.value)&&(l.value=n,l.plugin.set&&l.plugin.set(l),Object.values(l.callbacks).forEach(e=>setTimeout(e,0,l.value)));else{const e=u(t,n);e.plugin.set&&(e.value=n,e.plugin.set(e))}}function f(e){const t=o[e];return!!t&&(t.clean=void 0,void 0!==t.plugin.threshold&&Date.now()-t.last<t.plugin.threshold?void 0:(h(t),t.plugin.refresh(t,t=>{g(e,t)}),!0))}function d(e,t,n={}){const{first:r,interval:l}=n,a=u(e,r),o=v(e,t,l);return a.clean=void 0,void 0!==a.value&&t(a.value),Date.now()-a.last>a.plugin.threshold&&f(e),o}function m(e){const t=o[e];if(t)return t.clean=void 0,o[e].value;const n=i(e);return n.get?n.get(e):void 0}function k(e,r){const[l,a]=t(()=>m(e)||r.first);return n(()=>d(e,a,r),[e]),l}function p(e){s.unshift(e)}var b={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(localStorage[e.key])},getEndpoint(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:e=>localStorage[e.substr(15)],set(e){localStorage[e.key]=e.value}};var S={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(sessionStorage[e.key])},getEndpoint(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:e=>sessionStorage[e.substr(17)],set(e){sessionStorage[e.key]=e.value}},y={};function E(e){const t=e.replace(/\.?[^.]*$/,"");if(!t)return;const n=o[t];n&&(n.value=r(y,n.url),Object.values(n.callbacks).forEach(e=>setTimeout(e,0,n.value))),setTimeout(E,0,t)}function I(t){const n=o[t],l=`${t}.`;Object.keys(o).forEach(a=>{if(!a.startsWith(l))return;const s=o[a],i=r(n.value,a.substr(t.length+1));e(i,s.value)&&(s.value=i,Object.values(s.callbacks).forEach(e=>setTimeout(e,0,i)))})}var j={name:"state",regex:/^state:\/\/./,refresh(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint(e){const t=r(y,e.url);if(void 0===t)return y=l(y,e.url,e.value),E(e.url),void I(e.url);e.value=t},get:e=>r(y,e),set(e){y=l(y,e.url,e.value),E(e.url),I(e.url)},clean(e){const t=`${e.url}.`;Object.keys(o).some(e=>e.startsWith(t))||E(e.url)}};p({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:(e,t)=>fetch(e.url).then(e=>{e.json().then(t).catch(()=>{e.text().then(t).catch(t)})}).catch(t)}),p(b),p(S),p(j);export{a as conf,o as endpoints,m as get,d as onGet,s as plugins,f as refresh,p as registerPlugin,g as set,k as useOnGet};
