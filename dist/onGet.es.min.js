import e from"isdifferent";import{useState as t,useEffect as n}from"react";import{getValue as l,setValue as o}from"@hacknlove/deepobject";const r={CACHE_SIZE:100},a={},s=[];function c(e){return s.find(t=>e.match(t.regex))}function i(){const e=Object.values(a);r.CACHE_SIZE>e.length||e.forEach(e=>{e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(a[e.url].timeout),delete a[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)})}function u(e,t){if(a[e])return a[e];setTimeout(i);const n=c(e);if(!n)throw Error(`No plugin for ${e}`);const l={url:e,plugin:n,value:t,callbacks:{}};return a[e]=l,n.checkInterval&&(l.intervals={},l.minInterval=1/0),void 0!==n.threshold&&(l.last=-1/0),n.getEndpoint&&n.getEndpoint(l),l}function v(e,t,n){const l=a[e];var o;do{o=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(l.callbacks[o]);return l.callbacks[o]=t,l.intervals&&(l.intervals[o]=n=n||l.plugin.checkInterval,l.minInterval=Math.min(l.minInterval,n)),function(e,t){return()=>{e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min(...Object.values(e.intervals))))}}(l,o)}function g(e){e.intervals&&(clearTimeout(e.timeout),a[e.url]&&(e.last=Date.now(),e.timeout=setTimeout(()=>{f(e.url)},e.minInterval)))}function h(t,n,l){const o=a[t];if(o)o.clean=void 0,o.intervals&&l&&g(o),e(n,o.value)&&(o.value=n,o.plugin.set&&o.plugin.set(o),Object.values(o.callbacks).forEach(e=>setTimeout(e,0,o.value)));else{const e=u(t,n);e.plugin.set&&(e.value=n,e.plugin.set(e))}}function f(e){const t=a[e];return!!t&&(t.clean=void 0,void 0!==t.plugin.threshold&&Date.now()-t.last<t.plugin.threshold?void 0:(g(t),t.plugin.refresh(t,t=>{h(e,t)}),!0))}function d(e,t,n={}){const{first:l,interval:o}=n,r=u(e,l),a=v(e,t,o);return r.clean=void 0,void 0!==r.value&&t(r.value),Date.now()-r.last>r.plugin.threshold&&f(e),a}function m(e){const t=a[e];if(t)return t.clean=void 0,a[e].value;const n=c(e);return n.get?n.get(e):void 0}function p(e,l={}){const[o,r]=t(()=>m(e)||l.first);return n(()=>d(e,r,l),[e]),o}function k(e,t,...n){const l=a[e]||{plugin:c(e)};if(l.plugin.commands){if(l.plugin.commands[t])return l.plugin.commands[t](e,...n);console.warn("command not found")}else console.warn("the plugin does not accept commands")}function b(e){s.unshift(e)}var S={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(localStorage[e.key])},getEndpoint(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:e=>localStorage[e.substr(15)],set(e){localStorage[e.key]=e.value}};var y={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(sessionStorage[e.key])},getEndpoint(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:e=>sessionStorage[e.substr(17)],set(e){sessionStorage[e.key]=e.value}},E={};function I(e){const t=e.replace(/\.?[^.]*$/,"");if(!t)return;const n=a[t];n&&(n.value=l(E,n.url),Object.values(n.callbacks).forEach(e=>setTimeout(e,0,n.value))),setTimeout(I,0,t)}function j(t){const n=a[t],o=`${t}.`;Object.keys(a).forEach(r=>{if(!r.startsWith(o))return;const s=a[r],c=l(n.value,r.substr(t.length+1));e(c,s.value)&&(s.value=c,Object.values(s.callbacks).forEach(e=>setTimeout(e,0,c)))})}var w={name:"state",regex:/^dotted:\/\/./,refresh(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint(e){const t=l(E,e.url);if(void 0===t)return E=o(E,e.url,e.value),I(e.url),void j(e.url);e.value=t},get:e=>l(E,e),set(e){E=o(E,e.url,e.value),I(e.url),j(e.url)},clean(e){const t=`${e.url}.`;Object.keys(a).some(e=>e.startsWith(t))||I(e.url)}};b({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:(e,t)=>fetch(e.url).then(e=>{e.json().then(t).catch(()=>{e.text().then(t).catch(t)})}).catch(t)}),b(S),b(y),b(w);export{k as command,r as conf,a as endpoints,m as get,d as onGet,s as plugins,f as refresh,b as registerPlugin,h as set,p as useOnGet};
