import e from"isdifferent";import{useState as t,useEffect as r}from"react";import{getValue as o,setValue as n}from"@hacknlove/deepobject";const s={CACHE_SIZE:100},l={},a=[];function c(e){return a.find(t=>e.match(t.regex))}function u(){const e=Object.values(l);s.CACHE_SIZE>e.length||e.forEach(e=>{e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(l[e.url].timeout),delete l[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)})}function i(e,t){if(l[e])return l[e];setTimeout(u);const r=c(e);if(!r)throw Error(`No plugin for ${e}`);const o={url:e,plugin:r,value:t,callbacks:{}};return l[e]=o,r.checkInterval&&(o.intervals={},o.minInterval=1/0),void 0!==r.threshold&&(o.last=-1/0),r.getEndpoint&&r.getEndpoint(o),o}function h(e,t,r){const o=l[e];var n;do{n=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(o.callbacks[n]);return o.callbacks[n]=t,o.intervals&&(o.intervals[n]=r=r||o.plugin.checkInterval,o.minInterval=Math.min(o.minInterval,r)),function(e,t){return()=>{e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min(...Object.values(e.intervals))))}}(o,n)}function v(e){e.intervals&&(clearTimeout(e.timeout),l[e.url]&&(e.last=Date.now(),e.timeout=setTimeout(()=>{f(e.url)},e.minInterval)))}function g(t,r,o){const n=l[t];if(n)n.clean=void 0,n.intervals&&o&&v(n),e(r,n.value)&&(n.value=r,n.plugin.set&&n.plugin.set(n),Object.values(n.callbacks).forEach(e=>setTimeout(e,0,n.value)));else{const e=i(t,r);e.plugin.set&&(e.value=r,e.plugin.set(e))}}function f(e){const t=l[e];return!!t&&(t.clean=void 0,void 0!==t.plugin.threshold&&Date.now()-t.last<t.plugin.threshold?void 0:(v(t),t.plugin.refresh(t,t=>{g(e,t)}),!0))}function d(e,t,r={}){const{first:o,interval:n}=r,s=i(e,o),l=h(e,t,n);return s.clean=void 0,void 0!==s.value&&t(s.value),Date.now()-s.last>s.plugin.threshold&&f(e),l}function m(e){const t=l[e];if(t)return t.clean=void 0,l[e].value;const r=c(e);return r.get?r.get(e):void 0}function p(e,o={}){const[n,s]=t(()=>m(e)||o.first);return r(()=>d(e,s,o),[e]),n}function y(e,t,...r){const o=l[e]||{plugin:c(e)};if(o.plugin.commands){if(o.plugin.commands[t])return o.plugin.commands[t](e,...r);console.warn("command not found")}else console.warn("the plugin does not accept commands")}function k(e){a.unshift(e)}var b={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(localStorage[e.key])},getEndpoint(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:e=>localStorage[e.substr(15)],set(e){localStorage[e.key]=e.value}};var E={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(sessionStorage[e.key])},getEndpoint(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:e=>sessionStorage[e.substr(17)],set(e){sessionStorage[e.key]=e.value}};const S={};function j(e,t,...r){const o=S[e.replace(/#-?\d+$/,"")];if(o)return o;t&&"history://"===e&&I.commands[t]&&Object.keys(S).forEach(e=>I.commands[t](e,...r))}function w(e,t){const r=S[e];if(!r)return;const o=r.cursor-t;return o>=0&&r.history.length>o?r.history[o]:void 0}function O(t){const r=`${t}#`;Object.values(l).forEach(t=>{if(!t.relative)return;if(!t.url.startsWith(r))return;const o=w(t.relative.url,t.relative.n);e(o,t.value)&&(t.value=o,Object.values(t.callbacks).forEach(e=>setTimeout(e,0,t.value)))})}const I={name:"history",regex:/^history:\/\/./,refresh(){console.warn("refresh does nothing with history:// plugin")},getEndpoint(e){const t=e.url.match(/(.*)#(-?\d+)$/);t?(e.relative={url:t[1],n:1*t[2]},e.value=w(t[1],1*t[2])):S[e.url]={history:[e.value],cursor:0}},get(e){if(S[e])return S[e].history[S[e].cursor];const t=e.match(/(.*)#(-?\d+)$/);return t?w(t[1],1*t[2]):void 0},set(e){const t=e.relative;if(!t){const t=S[e.url];return t.history.length>t.cursor&&t.history.splice(t.cursor+1),t.history.push(e.value),t.cursor++,void O(e.url)}const r=S[t.url];if(!r)return;const o=r.cursor-t.n;0>o||r.history.length>o&&(r.history[o]=e.value)},clean(e){const t=e.url.replace(/#-?\d+$/,"");S[e.url]&&(l[t]&&!l[t].clean||l.some(e=>!e.clean&&(!!e.relative&&e.relative.url===t))||delete S[e.url])},commands:{replace(e,t){e=e.replace(/#-?\d+$/,"");const r=S[e];if(!r)return void console.warn("cannot replace. History not found");r.history.length>r.cursor&&r.history.splice(r.cursor+1),r.history[r.cursor]=t,O(e);const o=l[e];o&&(o.value=t,Object.values(o.callbacks).forEach(e=>setTimeout(e,0,o.value)))},undo(e,t=1){const r=j(e,"undo",t=Math.floor(1*t));r&&(r.cursor=Math.max(0,r.cursor-t),O(e))},redo(e,t=1){const r=j(e,"redo",t=Math.floor(1*t));r&&(r.cursor=Math.min(r.cursor+t,r.history.length-1),O(e))},goto(e,t){const r=j(e,"goto",t=Math.floor(1*t));r&&(r.cursor=Math.max(0,Math.min(t,r.history.length-1)),O(e))},first(e){I.commands.undo(e,1/0)},last(e){I.commands.redo(e,1/0)},length(e){const t=j(e);return t?t.history.length:0},undoLength(e){const t=j(e);return t?t.cursor:0},redoLength(e){const t=j(e);return t?t.history.length-t.cursor-1:0}}};var x={};function M(e){const t=e.replace(/\.?[^.]*$/,"");if(!t)return;const r=l[t];r&&(r.value=o(x,r.url),Object.values(r.callbacks).forEach(e=>setTimeout(e,0,r.value))),setTimeout(M,0,t)}function T(t){const r=l[t],n=`${t}.`;Object.keys(l).forEach(s=>{if(!s.startsWith(n))return;const a=l[s],c=o(r.value,s.substr(t.length+1));e(c,a.value)&&(a.value=c,Object.values(a.callbacks).forEach(e=>setTimeout(e,0,c)))})}var $={name:"state",regex:/^dotted:\/\/./,refresh(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint(e){const t=o(x,e.url);if(void 0===t)return x=n(x,e.url,e.value),M(e.url),void T(e.url);e.value=t},get:e=>o(x,e),set(e){x=n(x,e.url,e.value),M(e.url),T(e.url)},clean(e){const t=`${e.url}.`;Object.keys(l).some(e=>e.startsWith(t))||M(e.url)}};k({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:(e,t)=>fetch(e.url).then(e=>{e.json().then(t).catch(()=>{e.text().then(t).catch(t)})}).catch(t)}),k(b),k(E),k(I),k($);export{y as command,s as conf,l as endpoints,m as get,d as onGet,a as plugins,f as refresh,k as registerPlugin,g as set,p as useOnGet};
