import e from"isdifferent";import{useState as t,useEffect as r}from"react";import{getValue as n,setValue as o}from"@hacknlove/deepobject";const s={CACHE_SIZE:100},l={},a=[];function c(e){return a.find(t=>e.match(t.regex))}function u(){const e=Object.values(l);s.CACHE_SIZE>e.length||e.forEach(e=>{e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(l[e.url].timeout),delete l[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)})}function i(e,t){if(l[e])return l[e];setTimeout(u);const r=c(e);if(!r)throw Error(`No plugin for ${e}`);const n={url:e,plugin:r,value:t,callbacks:{}};return l[e]=n,r.checkInterval&&(n.intervals={},n.minInterval=1/0),void 0!==r.threshold&&(n.last=-1/0),r.getEndpoint&&r.getEndpoint(n),n}function h(e,t,r){const n=l[e];var o;do{o=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(n.callbacks[o]);return n.callbacks[o]=t,n.intervals&&(n.intervals[o]=r=r||n.plugin.checkInterval,n.minInterval=Math.min(n.minInterval,r)),function(e,t){return()=>{e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min(...Object.values(e.intervals))))}}(n,o)}function v(e){e.intervals&&(clearTimeout(e.timeout),l[e.url]&&(e.last=Date.now(),e.timeout=setTimeout(()=>{g(e.url)},e.minInterval)))}function f(t,r,n){const o=l[t];if(o)o.clean=void 0,o.intervals&&n&&v(o),e(r,o.value)&&(o.value=r,o.plugin.set&&o.plugin.set(o),Object.values(o.callbacks).forEach(e=>setTimeout(e,0,o.value)));else{const e=i(t,r);e.plugin.set&&(e.value=r,e.plugin.set(e))}}function g(e,t=!1){const r=l[e];return!!r&&(r.clean=void 0,t||void 0===r.plugin.threshold||Date.now()-r.last>=r.plugin.threshold?(v(r),r.plugin.refresh(r,t=>{f(e,t)}),!0):void 0)}function d(e,t,r={}){const{first:n,interval:o}=r,s=i(e,n),l=h(e,t,o);return s.clean=void 0,void 0!==s.value&&t(s.value),Date.now()-s.last>s.plugin.threshold&&g(e),l}function m(e){const t=l[e];if(t)return t.clean=void 0,l[e].value;const r=c(e);return r.get?r.get(e):void 0}function p(e,n={}){let[o,s]=t(()=>m(e)||n.first);return n.firstIfUrlChanges&&(o=m(e)||n.first),r(()=>d(e,s,n),[e]),o}function y(e,t,...r){const n=l[e]||{plugin:c(e)};if(n.plugin.commands){if(n.plugin.commands[t])return n.plugin.commands[t](e,...r);console.warn("command not found")}else console.warn("the plugin does not accept commands")}function k(e){a.unshift(e)}var b={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(localStorage[e.key])},getEndpoint(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:e=>localStorage[e.substr(15)],set(e){localStorage[e.key]=e.value}};var S={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh(e,t){t(sessionStorage[e.key])},getEndpoint(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:e=>sessionStorage[e.substr(17)],set(e){sessionStorage[e.key]=e.value}};const E={};function j(e,t,...r){const n=E[e.replace(/#-?\d+$/,"")];if(n)return n;t&&"history://"===e&&M.commands[t]&&Object.keys(E).forEach(e=>M.commands[t](e,...r))}function w(e,t){const r=E[e];if(!r)return;const n=r.cursor-t;return n>=0&&r.history.length>n?r.history[n]:void 0}function I(t){const r=`${t}#`;Object.values(l).forEach(t=>{if(!t.relative)return;if(!t.url.startsWith(r))return;const n=w(t.relative.url,t.relative.n);e(n,t.value)&&(t.value=n,O(t.url))})}function O(e){const t=l[e];t&&Object.values(t.callbacks).forEach(e=>setTimeout(e,0,t.value))}function x(e){const t=l[e];if(!t)return;const r=E[e];t.value=r.history[r.cursor],O(e)}const M={name:"history",regex:/^history:\/\/./,refresh(){console.warn("refresh does nothing with history:// plugin")},getEndpoint(e){const t=e.url.match(/(.*)#(-?\d+)$/);t?(e.relative={url:t[1],n:1*t[2]},e.value=w(t[1],1*t[2])):E[e.url]={history:[e.value],cursor:0}},get(e){if(E[e])return E[e].history[E[e].cursor];const t=e.match(/(.*)#(-?\d+)$/);return t?w(t[1],1*t[2]):void 0},set(t){const r=t.relative;if(!r){const r=E[t.url];if(!e(t.value,r.history[r.cursor]))return;return r.history.length>r.cursor&&r.history.splice(r.cursor+1),r.history.push(t.value),r.cursor++,void I(t.url)}const n=E[r.url];if(!n)return;const o=n.cursor-r.n;0>o||n.history.length>o&&(n.history[o]=t.value)},clean(e){const t=e.url.replace(/#-?\d+$/,"");E[e.url]&&(l[t]&&!l[t].clean||l.some(e=>!e.clean&&(!!e.relative&&e.relative.url===t))||delete E[e.url])},commands:{replace(e,t){e=e.replace(/#-?\d+$/,"");const r=E[e];r?(r.history.length>r.cursor&&r.history.splice(r.cursor+1),r.history[r.cursor]=t,x(e),I(e)):console.warn("cannot replace. History not found")},undo(e,t=1){const r=j(e,"undo",t=Math.floor(1*t));r&&(r.cursor=Math.max(0,r.cursor-t),x(e),I(e))},redo(e,t=1){const r=j(e,"redo",t=Math.floor(1*t));r&&(r.cursor=Math.min(r.cursor+t,r.history.length-1),x(e),I(e))},goto(e,t){const r=j(e,"goto",t=Math.floor(1*t));r&&(r.cursor=Math.max(0,Math.min(t,r.history.length-1)),x(e),I(e))},first(e){M.commands.undo(e,1/0)},last(e){M.commands.redo(e,1/0)},length(e){const t=j(e);return t?t.history.length:0},undoLength(e){const t=j(e);return t?t.cursor:0},redoLength(e){const t=j(e);return t?t.history.length-t.cursor-1:0}}};var $={};function T(e){const t=e.replace(/\.?[^.]*$/,"");if(!t)return;const r=l[t];r&&(r.value=n($,r.url),Object.values(r.callbacks).forEach(e=>setTimeout(e,0,r.value))),setTimeout(T,0,t)}function C(t){const r=l[t],o=`${t}.`;Object.keys(l).forEach(s=>{if(!s.startsWith(o))return;const a=l[s],c=n(r.value,s.substr(t.length+1));e(c,a.value)&&(a.value=c,Object.values(a.callbacks).forEach(e=>setTimeout(e,0,c)))})}var D={name:"state",regex:/^dotted:\/\/./,refresh(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint(e){const t=n($,e.url);if(void 0===t)return $=o($,e.url,e.value),T(e.url),void C(e.url);e.value=t},get:e=>n($,e),set(e){$=o($,e.url,e.value),T(e.url),C(e.url)},clean(e){const t=`${e.url}.`;Object.keys(l).some(e=>e.startsWith(t))||T(e.url)}};k({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:(e,t)=>fetch(e.url).then(e=>{e.json().then(t).catch(()=>{e.text().then(t).catch(t)})}).catch(t)}),k(b),k(S),k(M),k(D);export{y as command,s as conf,l as endpoints,m as get,d as onGet,a as plugins,g as refresh,k as registerPlugin,f as set,p as useOnGet};
