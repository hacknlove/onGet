!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("isdifferent"),require("@hacknlove/deepobject")):"function"==typeof define&&define.amd?define(["exports","isdifferent","@hacknlove/deepobject"],t):t((e=e||self).onGet={},e.isDifferent,e.deepobject)}(this,(function(e,t,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var r={CACHE_SIZE:100},a={},u=[];function l(e){return u.find((function(t){return e.match(t.regex)}))}function o(){var e=Object.values(a);r.CACHE_SIZE>e.length||e.forEach((function(e){e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(a[e.url].timeout),delete a[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)}))}function i(e,t){if(a[e])return a[e];setTimeout(o);var n=l(e);if(!n)throw Error("No plugin for "+e);var r={url:e,plugin:n,value:t,callbacks:{}};return a[e]=r,n.checkInterval&&(r.intervals={},r.minInterval=1/0),void 0!==n.threshold&&(r.last=-1/0),n.getEndpoint&&n.getEndpoint(r),r}function s(e,t,n){var r,u=a[e];do{r=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(u.callbacks[r]);return u.callbacks[r]=t,u.intervals&&(u.intervals[r]=n=n||u.plugin.checkInterval,u.minInterval=Math.min(u.minInterval,n)),function(e,t){return function(){e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min.apply(Math,Object.values(e.intervals))))}}(u,r)}function c(e){e.intervals&&(clearTimeout(e.timeout),a[e.url]&&(e.last=Date.now(),e.timeout=setTimeout((function(){v(e.url)}),e.minInterval)))}function f(e,n,r){var u=a[e];if(u)u.clean=void 0,u.intervals&&r&&c(u),t(n,u.value)&&(u.value=n,u.plugin.set&&u.plugin.set(u),Object.values(u.callbacks).forEach((function(e){return setTimeout(e,0,u.value)})));else{var l=i(e,n);l.plugin.set&&(l.value=n,l.plugin.set(l))}}function v(e){var t=a[e];return!!t&&(t.clean=void 0,void 0!==t.plugin.threshold&&Date.now()-t.last<t.plugin.threshold?void 0:(c(t),t.plugin.refresh(t,(function(t){f(e,t)})),!0))}function h(e,t,n){void 0===n&&(n={});var r=n.interval,a=i(e,n.first),u=s(e,t,r);return a.clean=void 0,void 0!==a.value&&t(a.value),Date.now()-a.last>a.plugin.threshold&&v(e),u}function g(e){var t=a[e];if(t)return t.clean=void 0,a[e].value;var n=l(e);return n.get?n.get(e):void 0}var d=require("react"),p=d.useState,k=d.useEffect;function b(e){u.unshift(e)}var m={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(localStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:function(e){return localStorage[e.substr(15)]},set:function(e){localStorage[e.key]=e.value}},y={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(sessionStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:function(e){return sessionStorage[e.substr(17)]},set:function(e){sessionStorage[e.key]=e.value}},S={};function E(e){var t=e.replace(/\.?[^.]*$/,"");if(t){var r=a[t];r&&(r.value=n.getValue(S,r.url),Object.values(r.callbacks).forEach((function(e){return setTimeout(e,0,r.value)}))),setTimeout(E,0,t)}}function j(e){var r=a[e],u=e+".";Object.keys(a).forEach((function(l){if(l.startsWith(u)){var o=a[l],i=n.getValue(r.value,l.substr(e.length+1));t(i,o.value)&&(o.value=i,Object.values(o.callbacks).forEach((function(e){return setTimeout(e,0,i)})))}}))}var I={name:"state",regex:/^state:\/\/./,refresh:function(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint:function(e){var t=n.getValue(S,e.url);if(void 0===t)return S=n.setValue(S,e.url,e.value),E(e.url),void j(e.url);e.value=t},get:function(e){return n.getValue(S,e)},set:function(e){S=n.setValue(S,e.url,e.value),E(e.url),j(e.url)},clean:function(e){var t=e.url+".";Object.keys(a).some((function(e){return e.startsWith(t)}))||E(e.url)}};b({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:function(e,t){return fetch(e.url).then((function(e){e.json().then(t).catch((function(){e.text().then(t).catch(t)}))})).catch(t)}}),b(m),b(y),b(I),e.conf=r,e.endpoints=a,e.get=g,e.onGet=h,e.plugins=u,e.refresh=v,e.registerPlugin=b,e.set=f,e.useOnGet=function(e,t){var n=p((function(){return g(e)||t.first})),r=n[0],a=n[1];return k((function(){return h(e,a,t)}),[e]),r},Object.defineProperty(e,"__esModule",{value:!0})}));
