"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=t(e);class r{constructor(e,t={}){this.url=e,this.cached=t.firstValue,this.defaultValue=t.defaultValue,this.subscriptions=new Map,this.totalSubscriptionsCount=0}setValue(e){this.cached=e,this.triggerSubscriptions()}getValue(){return this.cached??this.defaultValue}triggerSubscriptions(){for(const e of this.subscriptions.values())e(this.value,this)}get value(){return this.getValue()}set value(e){this.setValue(e)}onChange(e){const t=this.totalSubscriptionsCount++;return this.subscriptions.set(t,e),()=>this.subscriptions.delete(t)}}class u{newResource(e,t){return new r(e,t)}}u.protocol="var";const n={},i={get:(e,t)=>e.getValue(t),deleteProperty(e,t){e.deleteReource(t)},set:(e,t,s)=>(e.setValue(t,s),!0)};class o{constructor({plugins:e=[],conf:t={}}){this.plugins=new Map(e.map(e=>[e.protocol,new e(this)])),this.plugins.has("var")||this.plugins.set("var",new u(this)),this.conf={...n,...t},this.resources=new Map,this.proxy=new Proxy(this,i)}findPlugin(e){return this.plugins.get(e.split(":",1))||this.plugins.get("var")}getResource(e,t={}){let s=this.resources.get(e);if(s)return s;return s=this.findPlugin(e).newResource(e,t,this),this.resources.set(e,s),s}getValue(e,t={}){return this.getResource(e,t).value}setValue(e,t,s={}){this.getResource(e,s).setValue(t,s)}deleteReource(e){this.getResource(e).delete(),this.resources.delete(e)}onChange(e,t,s){return this.getResource(e).onChange(t,s)}}var a=e.createContext({});function l(t,s){"string"==typeof t&&(t=c(t,s));var r=e.useState(t.value),u=r[0],n=r[1];return h(t.url,(function(e){return n(e)}),null),[u,function(e){return t.setValue(e)},t]}function c(t,s){return e.useContext(a).getResource(t,s)}function h(t,s,r){var u=e.useContext(a);e.useEffect((function(){return u.onChange(t,s,r)}),[t])}exports.ContextState=a,exports.OnGetProvider=function(t){var r=t.children,u=t.plugins,n=void 0===u?[]:u,i=t.conf,l=void 0===i?{}:i,c=t.testContextRef,h=e.useMemo((function(){var e=new o({plugins:n,conf:l});return c&&(c.sharedState=e),e}),[]);return s.default.createElement(a.Provider,{value:h},r)},exports.WithOnGetValue=function(e){var t=e.url,s=e.children,r=l(t,null);return s({value:r[0],setValue:r[1],resource:r[2]})},exports.useOnGetChange=h,exports.useOnGetResource=c,exports.useOnGetState=function(){return e.useContext(a)},exports.useOnGetValue=l;
