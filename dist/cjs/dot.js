"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@hacknlove/deepobject");function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=e(require("proxy-deep"));const r={get(t,e){const s=t===this.rootTarget?t.cached[e]:t[e];return"object"==typeof s&&null!==s?this.nest({resource:t.resource}):s},deleteProperty(){this.rootTarget.plugin.delete(this.rootTarget.url+"."+this.path.join("."))},set(t,e,s){return this.rootTarget.plugin.setValue(this.rootTarget.url+"."+this.path.join("."),s),!0}};class i extends class{constructor(t,e={}){this.url=t,this.cached=e.firstValue,this.defaultValue=e.defaultValue,this.subscriptions=new Map,this.totalSubscriptionsCount=0}setValue(t){this.cached=t,this.triggerSubscriptions()}getValue(){return this.cached??this.defaultValue}triggerSubscriptions(){for(const t of this.subscriptions.values())t(this.value,this)}get value(){return this.getValue()}set value(t){this.setValue(t)}onChange(t){const e=this.totalSubscriptionsCount++;return this.subscriptions.set(e,t),()=>this.subscriptions.delete(e)}}{constructor(t,e,s){super(t,e),this.plugin=s,void 0!==e.firstValue&&void 0===this.value&&(this.value=e.firstValue)}setValue(t){this.plugin.setValue(this.url,t),this.cached=t,super.triggerSubscriptions()}setChild(t,e){this.plugin.setValue(this.url+"."+t,e)}getChild(e){return t.getValue(this.cached,e)}delete(){delete this.cached,this.plugin.delete(this.url)}triggerSubscriptions(){for(const t of this.subscriptions.values())t(this.cached,this)}proxy(){if(this.proxy)return this.proxy;this.proxy=new s.default(this,r)}}class o{constructor(t){this.sharedState=t,this.state={}}newResource(t,e){return new i(t,e,this)}getValue(e){return t.getValue(this.state,e)}setValue(e,s){this.state=t.setValue(this.state,e,s),this.propagateDown(e),this.propagateUp(e)}delete(e){this.state=t.deleteValue(this.state,e),this.propagateUp(e),this.propagateDown(e)}propagateUp(t){const e=t.replace(/\.?[^.]*$/,"");if(!e)return;const s=this.sharedState.resources.get(e);s&&s.triggerSubscriptions(),this.propagateUp(e)}propagateDown(t){const e=t+".";for(const t of this.sharedState.resources.values())t.url.startsWith(e)&&t.triggerSubscriptions()}}o.protocol="dot",exports.DotResource=i,exports.default=o;
