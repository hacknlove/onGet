!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("isdifferent"),require("react"),require("@hacknlove/deepobject")):"function"==typeof define&&define.amd?define(["exports","isdifferent","react","@hacknlove/deepobject"],t):t((e=e||self).onGet={},e.isDifferent,e.react,e.deepobject)}(this,(function(e,t,n,r){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var a={CACHE_SIZE:100},u={},l=[];function o(e){return l.find((function(t){return e.match(t.regex)}))}function i(){var e=Object.values(u);a.CACHE_SIZE>e.length||e.forEach((function(e){e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(u[e.url].timeout),delete u[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)}))}function s(e,t){if(u[e])return u[e];setTimeout(i);var n=o(e);if(!n)throw Error("No plugin for "+e);var r={url:e,plugin:n,value:t,callbacks:{}};return u[e]=r,n.checkInterval&&(r.intervals={},r.minInterval=1/0),void 0!==n.threshold&&(r.last=-1/0),n.getEndpoint&&n.getEndpoint(r),r}function c(e,t,n){var r,a=u[e];do{r=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(a.callbacks[r]);return a.callbacks[r]=t,a.intervals&&(a.intervals[r]=n=n||a.plugin.checkInterval,a.minInterval=Math.min(a.minInterval,n)),function(e,t){return function(){e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min.apply(Math,Object.values(e.intervals))))}}(a,r)}function f(e){e.intervals&&(clearTimeout(e.timeout),u[e.url]&&(e.last=Date.now(),e.timeout=setTimeout((function(){h(e.url)}),e.minInterval)))}function v(e,n,r){var a=u[e];if(a)a.clean=void 0,a.intervals&&r&&f(a),t(n,a.value)&&(a.value=n,a.plugin.set&&a.plugin.set(a),Object.values(a.callbacks).forEach((function(e){return setTimeout(e,0,a.value)})));else{var l=s(e,n);l.plugin.set&&(l.value=n,l.plugin.set(l))}}function h(e){var t=u[e];return!!t&&(t.clean=void 0,void 0!==t.plugin.threshold&&Date.now()-t.last<t.plugin.threshold?void 0:(f(t),t.plugin.refresh(t,(function(t){v(e,t)})),!0))}function g(e,t,n){void 0===n&&(n={});var r=n.interval,a=s(e,n.first),u=c(e,t,r);return a.clean=void 0,void 0!==a.value&&t(a.value),Date.now()-a.last>a.plugin.threshold&&h(e),u}function d(e){var t=u[e];if(t)return t.clean=void 0,u[e].value;var n=o(e);return n.get?n.get(e):void 0}function p(e){l.unshift(e)}var k={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(localStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:function(e){return localStorage[e.substr(15)]},set:function(e){localStorage[e.key]=e.value}},b={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(sessionStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:function(e){return sessionStorage[e.substr(17)]},set:function(e){sessionStorage[e.key]=e.value}},m={};function y(e){var t=e.replace(/\.?[^.]*$/,"");if(t){var n=u[t];n&&(n.value=r.getValue(m,n.url),Object.values(n.callbacks).forEach((function(e){return setTimeout(e,0,n.value)}))),setTimeout(y,0,t)}}function S(e){var n=u[e],a=e+".";Object.keys(u).forEach((function(l){if(l.startsWith(a)){var o=u[l],i=r.getValue(n.value,l.substr(e.length+1));t(i,o.value)&&(o.value=i,Object.values(o.callbacks).forEach((function(e){return setTimeout(e,0,i)})))}}))}var E={name:"state",regex:/^state:\/\/./,refresh:function(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint:function(e){var t=r.getValue(m,e.url);if(void 0===t)return m=r.setValue(m,e.url,e.value),y(e.url),void S(e.url);e.value=t},get:function(e){return r.getValue(m,e)},set:function(e){m=r.setValue(m,e.url,e.value),y(e.url),S(e.url)},clean:function(e){var t=e.url+".";Object.keys(u).some((function(e){return e.startsWith(t)}))||y(e.url)}};p({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:function(e,t){return fetch(e.url).then((function(e){e.json().then(t).catch((function(){e.text().then(t).catch(t)}))})).catch(t)}}),p(k),p(b),p(E),e.conf=a,e.endpoints=u,e.get=d,e.onGet=g,e.plugins=l,e.refresh=h,e.registerPlugin=p,e.set=v,e.useOnGet=function(e,t){var r=n.useState((function(){return d(e)||t.first})),a=r[0],u=r[1];return n.useEffect((function(){return g(e,u,t)}),[e]),a},Object.defineProperty(e,"__esModule",{value:!0})}));
