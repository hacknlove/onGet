!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("isdifferent"),require("react"),require("@hacknlove/deepobject")):"function"==typeof define&&define.amd?define(["exports","isdifferent","react","@hacknlove/deepobject"],t):t((e=e||self).onGet={},e.isDifferent,e.React,e.deepObject)}(this,(function(e,t,r,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var o={CACHE_SIZE:100},a={},u=[];function i(e){return u.find((function(t){return e.match(t.regex)}))}function l(){var e=Object.values(a);o.CACHE_SIZE>e.length||e.forEach((function(e){e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(a[e.url].timeout),delete a[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)}))}function c(e,t){if(a[e])return a[e];setTimeout(l);var r=i(e);if(!r)throw Error("No plugin for "+e);var n={url:e,plugin:r,value:t,callbacks:{}};return a[e]=n,r.checkInterval&&(n.intervals={},n.minInterval=1/0),void 0!==r.threshold&&(n.last=-1/0),r.getEndpoint&&r.getEndpoint(n),n}function s(e,t,r){var n,o=a[e];do{n=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(o.callbacks[n]);return o.callbacks[n]=t,o.intervals&&(o.intervals[n]=r=r||o.plugin.checkInterval,o.minInterval=Math.min(o.minInterval,r)),function(e,t){return function(){e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min.apply(Math,Object.values(e.intervals))))}}(o,n)}function f(e){e.intervals&&(clearTimeout(e.timeout),a[e.url]&&(e.last=Date.now(),e.timeout=setTimeout((function(){h(e.url)}),e.minInterval)))}function v(e,r,n){var o=a[e];if(o)o.clean=void 0,o.intervals&&n&&f(o),t(r,o.value)&&(o.value=r,o.plugin.set&&o.plugin.set(o),Object.values(o.callbacks).forEach((function(e){return setTimeout(e,0,o.value)})));else{var u=c(e,r);u.plugin.set&&(u.value=r,u.plugin.set(u))}}function h(e,t){void 0===t&&(t=!1);var r=a[e];return!!r&&(r.clean=void 0,t||void 0===r.plugin.threshold||Date.now()-r.last>=r.plugin.threshold?(f(r),r.plugin.refresh(r,(function(t){v(e,t)})),!0):void 0)}function d(e,t,r){void 0===r&&(r={});var n=r.interval,o=c(e,r.first),a=s(e,t,n);return o.clean=void 0,void 0!==o.value&&t(o.value),Date.now()-o.last>o.plugin.threshold&&h(e),a}function g(e){var t=a[e];if(t)return t.clean=void 0,a[e].value;var r=i(e);return r.get?r.get(e):void 0}function m(e){u.unshift(e)}var p={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(localStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:function(e){return localStorage[e.substr(15)]},set:function(e){localStorage[e.key]=e.value}},y={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(sessionStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:function(e){return sessionStorage[e.substr(17)]},set:function(e){sessionStorage[e.key]=e.value}},k={};function b(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),o=2;r>o;o++)n[o-2]=arguments[o];var a=k[e.replace(/#-?\d+$/,"")];if(a)return a;t&&"history://"===e&&w.commands[t]&&Object.keys(k).forEach((function(e){var r;return(r=w.commands)[t].apply(r,[e].concat(n))}))}function S(e,t){var r=k[e];if(r){var n=r.cursor-t;if(n>=0&&r.history.length>n)return r.history[n]}}function E(e){var r=e+"#";Object.values(a).forEach((function(e){if(e.relative&&e.url.startsWith(r)){var n=S(e.relative.url,e.relative.n);t(n,e.value)&&(e.value=n,j(e.url))}}))}function j(e){var t=a[e];t&&Object.values(t.callbacks).forEach((function(e){return setTimeout(e,0,t.value)}))}function O(e){var t=a[e];if(t){var r=k[e];t.value=r.history[r.cursor],j(e)}}var w={name:"history",regex:/^history:\/\/./,refresh:function(){console.warn("refresh does nothing with history:// plugin")},getEndpoint:function(e){var t=e.url.match(/(.*)#(-?\d+)$/);t?(e.relative={url:t[1],n:1*t[2]},e.value=S(t[1],1*t[2])):k[e.url]={history:[e.value],cursor:0}},get:function(e){if(k[e])return k[e].history[k[e].cursor];var t=e.match(/(.*)#(-?\d+)$/);return t?S(t[1],1*t[2]):void 0},set:function(e){var r=e.relative;if(!r){var n=k[e.url];if(!t(e.value,n.history[n.cursor]))return;return n.history.length>n.cursor&&n.history.splice(n.cursor+1),n.history.push(e.value),n.cursor++,void E(e.url)}var o=k[r.url];if(o){var a=o.cursor-r.n;0>a||o.history.length>a&&(o.history[a]=e.value)}},clean:function(e){var t=e.url.replace(/#-?\d+$/,"");k[e.url]&&(a[t]&&!a[t].clean||a.some((function(e){return!e.clean&&(!!e.relative&&e.relative.url===t)}))||delete k[e.url])},commands:{replace:function(e,t){e=e.replace(/#-?\d+$/,"");var r=k[e];r?(r.history.length>r.cursor&&r.history.splice(r.cursor+1),r.history[r.cursor]=t,O(e),E(e)):console.warn("cannot replace. History not found")},undo:function(e,t){void 0===t&&(t=1);var r=b(e,"undo",t=Math.floor(1*t));r&&(r.cursor=Math.max(0,r.cursor-t),O(e),E(e))},redo:function(e,t){void 0===t&&(t=1);var r=b(e,"redo",t=Math.floor(1*t));r&&(r.cursor=Math.min(r.cursor+t,r.history.length-1),O(e),E(e))},goto:function(e,t){var r=b(e,"goto",t=Math.floor(1*t));r&&(r.cursor=Math.max(0,Math.min(t,r.history.length-1)),O(e),E(e))},first:function(e){w.commands.undo(e,1/0)},last:function(e){w.commands.redo(e,1/0)},length:function(e){var t=b(e);return t?t.history.length:0},undoLength:function(e){var t=b(e);return t?t.cursor:0},redoLength:function(e){var t=b(e);return t?t.history.length-t.cursor-1:0}}},I={};function x(e){var t=e.replace(/\.?[^.]*$/,"");if(t){var r=a[t];r&&(r.value=n.getValue(I,r.url),Object.values(r.callbacks).forEach((function(e){return setTimeout(e,0,r.value)}))),setTimeout(x,0,t)}}function M(e){var r=a[e],o=e+".";Object.keys(a).forEach((function(u){if(u.startsWith(o)){var i=a[u],l=n.getValue(r.value,u.substr(e.length+1));t(l,i.value)&&(i.value=l,Object.values(i.callbacks).forEach((function(e){return setTimeout(e,0,l)})))}}))}var T={name:"state",regex:/^dotted:\/\/./,refresh:function(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint:function(e){var t=n.getValue(I,e.url);if(void 0===t)return I=n.setValue(I,e.url,e.value),x(e.url),void M(e.url);e.value=t},get:function(e){return n.getValue(I,e)},set:function(e){I=n.setValue(I,e.url,e.value),x(e.url),M(e.url)},clean:function(e){var t=e.url+".";Object.keys(a).some((function(e){return e.startsWith(t)}))||x(e.url)}};m({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:function(e,t){return fetch(e.url).then((function(e){e.json().then(t).catch((function(){e.text().then(t).catch(t)}))})).catch(t)}}),m(p),m(y),m(w),m(T),e.command=function(e,t){var r,n=a[e]||{plugin:i(e)};if(n.plugin.commands){if(n.plugin.commands[t]){for(var o=arguments.length,u=Array(o>2?o-2:0),l=2;o>l;l++)u[l-2]=arguments[l];return(r=n.plugin.commands)[t].apply(r,[e].concat(u))}console.warn("command not found")}else console.warn("the plugin does not accept commands")},e.conf=o,e.endpoints=a,e.get=g,e.onGet=d,e.plugins=u,e.refresh=h,e.registerPlugin=m,e.set=v,e.useOnGet=function(e,t){void 0===t&&(t={});var n=r.useState((function(){return g(e)||t.first})),o=n[0],a=n[1];return t.firstIfUrlChanges&&(o=g(e)||t.first),r.useEffect((function(){return d(e,a,t)}),[e]),o},Object.defineProperty(e,"__esModule",{value:!0})}));
