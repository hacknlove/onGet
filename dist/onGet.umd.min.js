!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("isdifferent"),require("react"),require("@hacknlove/deepobject")):"function"==typeof define&&define.amd?define(["exports","isdifferent","react","@hacknlove/deepobject"],t):t((e=e||self).onGet={},e.isDifferent,e.react,e.deepObject)}(this,(function(e,t,n,r){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var a={CACHE_SIZE:100},o={},u=[];function l(e){return u.find((function(t){return e.match(t.regex)}))}function i(){var e=Object.values(o);a.CACHE_SIZE>e.length||e.forEach((function(e){e.clean?e.plugin.clean&&e.plugin.clean(e)||(clearTimeout(o[e.url].timeout),delete o[e.url]):0===Object.keys(e.callbacks).length&&(e.clean=!0)}))}function c(e,t){if(o[e])return o[e];setTimeout(i);var n=l(e);if(!n)throw Error("No plugin for "+e);var r={url:e,plugin:n,value:t,callbacks:{}};return o[e]=r,n.checkInterval&&(r.intervals={},r.minInterval=1/0),void 0!==n.threshold&&(r.last=-1/0),n.getEndpoint&&n.getEndpoint(r),r}function s(e,t,n){var r,a=o[e];do{r=Math.random().toString(36).substr(2)+(Date.now()%1e3).toString(36)}while(a.callbacks[r]);return a.callbacks[r]=t,a.intervals&&(a.intervals[r]=n=n||a.plugin.checkInterval,a.minInterval=Math.min(a.minInterval,n)),function(e,t){return function(){e.callbacks.hasOwnProperty(t)&&(delete e.callbacks[t],e.intervals&&(delete e.intervals[t],e.minInterval=Math.min.apply(Math,Object.values(e.intervals))))}}(a,r)}function f(e){e.intervals&&(clearTimeout(e.timeout),o[e.url]&&(e.last=Date.now(),e.timeout=setTimeout((function(){g(e.url)}),e.minInterval)))}function v(e,n,r){var a=o[e];if(a)a.clean=void 0,a.intervals&&r&&f(a),t(n,a.value)&&(a.value=n,a.plugin.set&&a.plugin.set(a),Object.values(a.callbacks).forEach((function(e){return setTimeout(e,0,a.value)})));else{var u=c(e,n);u.plugin.set&&(u.value=n,u.plugin.set(u))}}function g(e){var t=o[e];return!!t&&(t.clean=void 0,void 0!==t.plugin.threshold&&Date.now()-t.last<t.plugin.threshold?void 0:(f(t),t.plugin.refresh(t,(function(t){v(e,t)})),!0))}function d(e,t,n){void 0===n&&(n={});var r=n.interval,a=c(e,n.first),o=s(e,t,r);return a.clean=void 0,void 0!==a.value&&t(a.value),Date.now()-a.last>a.plugin.threshold&&g(e),o}function h(e){var t=o[e];if(t)return t.clean=void 0,o[e].value;var n=l(e);return n.get?n.get(e):void 0}function p(e){u.unshift(e)}var m={name:"localStorage",regex:/^localStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(localStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(15),void 0===localStorage[e.key]?localStorage[e.key]=e.value:e.value=localStorage[e.key]},get:function(e){return localStorage[e.substr(15)]},set:function(e){localStorage[e.key]=e.value}},k={name:"sessionStorage",regex:/^sessionStorage:\/\/./i,checkInterval:3e4,threshold:500,refresh:function(e,t){t(sessionStorage[e.key])},getEndpoint:function(e){e.key=e.url.substr(17),void 0===sessionStorage[e.key]?sessionStorage[e.key]=e.value:e.value=sessionStorage[e.key]},get:function(e){return sessionStorage[e.substr(17)]},set:function(e){sessionStorage[e.key]=e.value}},b={};function y(e){var t=e.replace(/\.?[^.]*$/,"");if(t){var n=o[t];n&&(n.value=r.getValue(b,n.url),Object.values(n.callbacks).forEach((function(e){return setTimeout(e,0,n.value)}))),setTimeout(y,0,t)}}function S(e){var n=o[e],a=e+".";Object.keys(o).forEach((function(u){if(u.startsWith(a)){var l=o[u],i=r.getValue(n.value,u.substr(e.length+1));t(i,l.value)&&(l.value=i,Object.values(l.callbacks).forEach((function(e){return setTimeout(e,0,i)})))}}))}var E={name:"state",regex:/^dotted:\/\/./,refresh:function(){console.warn("the true source for this plugin is client side, so refresh does nothing")},getEndpoint:function(e){var t=r.getValue(b,e.url);if(void 0===t)return b=r.setValue(b,e.url,e.value),y(e.url),void S(e.url);e.value=t},get:function(e){return r.getValue(b,e)},set:function(e){b=r.setValue(b,e.url,e.value),y(e.url),S(e.url)},clean:function(e){var t=e.url+".";Object.keys(o).some((function(e){return e.startsWith(t)}))||y(e.url)}};p({name:"fetch",regex:/^./,checkInterval:3e4,threshold:500,refresh:function(e,t){return fetch(e.url).then((function(e){e.json().then(t).catch((function(){e.text().then(t).catch(t)}))})).catch(t)}}),p(m),p(k),p(E),e.command=function(e,t){var n,r=o[e]||{plugin:l(e)};if(r.plugin.commands){if(r.plugin.commands[t]){for(var a=arguments.length,u=Array(a>2?a-2:0),i=2;a>i;i++)u[i-2]=arguments[i];return(n=r.plugin.commands)[t].apply(n,[e].concat(u))}console.warn("command not found")}else console.warn("the plugin does not accept commands")},e.conf=a,e.endpoints=o,e.get=h,e.onGet=d,e.plugins=u,e.refresh=g,e.registerPlugin=p,e.set=v,e.useOnGet=function(e,t){void 0===t&&(t={});var r=n.useState((function(){return h(e)||t.first})),a=r[0],o=r[1];return n.useEffect((function(){return d(e,o,t)}),[e]),a},Object.defineProperty(e,"__esModule",{value:!0})}));
